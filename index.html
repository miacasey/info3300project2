<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>

    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>
    <script src="https://unpkg.com/d3-simple-slider"></script>
    <!-- https://bl.ocks.org/johnwalley/e1d256b81e51da68f7feb632a53c3518 -->
</head>
<style>
.outline {
  stroke: gainsboro;
  stroke-width: 1px;
  fill: none;
}
</style>
<body>

  <!-- scatterplot -->
  <svg id = "scatter" width = 1200 height = 550 style = "border: 1px solid black">
  </svg>
  <!-- map -->
  <div width= 1200>
      <svg id = "map_canvas" width = 800 height = 900 style = "background : #fff; border: 1px solid grey"></svg>
      <svg id= "map_sliders" width= 325 height= 900 style = "background : #fff; border: 1px solid grey"></svg>
  </div>
  <script>
  const requestData = async() => {

    const may2018 = await d3.csv("/May2018.csv");
    const jan2018 = await d3.csv("/Jan2018.csv");
    const aug2016 = await d3.csv("/August2016.csv");
    const july2015 = await d3.csv("/July2015.csv");
    const jan2014 = await d3.csv("/2014.csv");
    const bay = await d3.json("/baycounties.json");
    console.log(bay);

    // map creation
    var map = d3.select("#map_canvas");
    var mapWidth = map.attr("width")-10;
    var mapHeight = map.attr("height")-20;
    let viewport = map.append('g');

    var bayMesh = topojson.mesh(bay, bay.objects.baycounties);
    var projection = d3.geoMercator().fitSize([mapWidth, mapHeight], bayMesh);
    var path = d3.geoPath().projection(projection);

    viewport.append("path")
      .datum(bayMesh)
      .attr("class", "outline")
      .attr("d", path);
    
    const location = await d3.csv("/locationsalary.csv");
    var femaleVal= 0
    var asianVal= 0
    var latinoVal= 0
    var blackVal= 0

    d3.select("#map_sliders")
        .append("text")
        .attr('transform', 'translate(30,80)')
        .text("Female")
    var sliderFemale= d3.sliderBottom()
        .min(0)
        .max(0.6)
        .width(250)
        .tickFormat(d3.format('.2%'))
        .ticks(5)
        .default(0)
        .on("onchange", val=>{
          femaleVal = val*100
          updateLocations()
        });
    var slide1= d3.select("#map_sliders")
        .append('g')
        .attr('transform', 'translate(30,110)')
    slide1.call(sliderFemale);
    
    d3.select("#map_sliders")
        .append("text")
        .attr('transform', 'translate(30,210)')
        .text("Asian")
    var sliderAsian= d3.sliderBottom()
        .min(0)
        .max(0.5)
        .width(250)
        .tickFormat(d3.format('.2%'))
        .ticks(5)
        .default(0)
        .on("onchange", val=>{
          asianVal = val*100
          updateLocations()
        });
    var slide2= d3.select("#map_sliders")
        .append('g')
        .attr('transform', 'translate(30,240)')
    slide2.call(sliderAsian);
    
    d3.select("#map_sliders")
        .append("text")
        .attr('transform', 'translate(30,340)')
        .text("Latino")
    var sliderLatino= d3.sliderBottom()
        .min(0)
        .max(0.2)
        .width(250)
        .tickFormat(d3.format('.2%'))
        .ticks(5)
        .default(0)
        .on("onchange", val=>{
          latinoVal = val*100
          updateLocations()
        });
    var slide3= d3.select("#map_sliders")
        .append('g')
        .attr('transform', 'translate(30,370)')
    slide3.call(sliderLatino);

    d3.select("#map_sliders")
        .append("text")
        .attr('transform', 'translate(30,470)')
        .text("Black")
    var sliderBlack= d3.sliderBottom()
        .min(0)
        .max(0.25)
        .width(250)
        .tickFormat(d3.format('.2%'))
        .ticks(5)
        .default(0)
        .on("onchange", val=>{
          blackVal = val*100
          updateLocations()
        });
    d3.select("#map_sliders")
        .append('g')
        .attr('transform', 'translate(30,500)')
        .call(sliderBlack);

    function updateLocations(){
      location.forEach (d => {
        d['position'] = projection([d.Longitude, d.Latitude]);
      });
      var circle= viewport.selectAll("circle").data(location);
      circle.exit().remove();
      circle.enter()
            .append("circle")
            .merge(circle)
            .attr("r", function(d){
              if (d.Female>femaleVal && d.Asian>asianVal && d.Latino>latinoVal && d.Black>blackVal){
                return 6;
              } else {
                return 0;
              }})
            .attr("opacity", 0.5)
            .attr("cx", d => d.position[0])
            .attr("cy", d => d.position[1])
            .style ("fill", "purple")
            .style("stroke-width", "1px");
    }
    updateLocations()
   // pan and zoom for map
   var zoom = d3.zoom()
              .scaleExtent([1,10])
              .on("zoom", zoomed);

  map.call(zoom);

  map.call(zoom.transform, d3.zoomIdentity);

  function zoomed(){
    let transform = d3.event.transform;
    console.log(transform);
    console.log(transform.toString());

    viewport.attr("transform", transform.toString());
    viewport.select(".outline")
            .style("stroke-width", 1/transform.k);


  }
  //


    //scatterplot data processing
    let data = [jan2014, july2015, aug2016, jan2018, may2018];

    function dataProcessing(company){

      let dataObject = {
        female: [],
        male: [],
        white: [],
        asian: [],
        latino: [],
        black: []
      };

      for (let i = 0; i < data.length; i++){
        let lineNum = 0;
        for (let j = 0; j < data[i].length; j++){
          if (data[i][j].Company === company){
            lineNum = j;
          }
        }

        dataObject.female.push(data[i][lineNum].Female.replace(/[^.\d]/g, ""));
        dataObject.male.push(data[i][lineNum].Male.replace(/[^.\d]/g, ""));
        dataObject.white.push(data[i][lineNum].White.replace(/[^.\d]/g, ""));
        dataObject.asian.push(data[i][lineNum].Asian.replace(/[^.\d]/g, ""));
        dataObject.latino.push(data[i][lineNum].Latino.replace(/[^.\d]/g, ""));
        dataObject.black.push(data[i][lineNum].Black.replace(/[^.\d]/g, ""));

      }

      return dataObject;

    }

    let usPopulation = dataProcessing("U.S. Population");
    let sampleAvg = dataProcessing("average from our sample");
    let diversityInc = dataProcessing("DiversityInc top 50");
    let fortune500 = dataProcessing("Fortune 500 CEOs");
    let congress = dataProcessing("US Congress");

    //scales
    let xScale = d3.scaleLinear()
                   .domain([0, 4])
                   .range([0, 800]);

    let yScale = d3.scaleLinear()
                   .domain([0, 100])
                   .range([500, 0]);

    //grid
    let svg = d3.select("svg#scatter");

    let leftAxis = d3.axisLeft(yScale);
    svg.append("g")
      .attr("class", "y axis")
      .attr("transform", "translate(25, 10)")
      .call(leftAxis);
    //x-axis grids
    for (let i = 0; i < 5; i++){
      svg.append('line')
         .attr('x1', xScale(i))
	       .attr('x2', xScale(i))
	       .attr('y1', 500)
         .attr('y2', 0)
         .style('stroke', 'black')
         .style("opacity", 0.4)
         .attr("transform", "translate(25, 10)");

      svg.append("text")
         .attr("x", xScale(i))
         .attr("y", 500)
         .text(i + 2014)
         .style('color', 'black')
         .attr("transform", "translate(10, 30)");
    }

    //y-axis grids
    for (let j = 0; j <= 100; j+=10){
      svg.append('line')
         .attr('x1', 0)
         .attr('x2', 800)
         .attr('y1', yScale(j))
         .attr('y2', yScale(j))
         .style('stroke', 'black')
         .style("opacity", 0.4)
         .attr("transform", "translate(25, 10)");
    }

    var line = d3.line()
                 .x(function(d, i) { return xScale(i); })
                 .y(function(d) { return yScale(d); });



    let processedData = [usPopulation, sampleAvg, diversityInc, fortune500, congress];
    let colors = ["red", "green", "purple", "gold", "blue"];
    let labels = ["U.S. Population", "Companies Average", "DiversityInc Top 50",
                    "Fortune 500 CEOs", "U.S Congress"];
    let categories = ["Female", "Male", "White", "Asian", "Latino", "Black"];

    //legend
    let legend = svg.append("g")
                    .attr("transform", "translate(850, 10)");

    for (let j = 0; j < 5; j++){
      legend.append("rect")
         .attr("x", 0)
         .attr("y", j * 25)
         .attr("width", 30)
         .attr("height", 20)
         .attr("fill", colors[j]);

      legend.append("text")
        .attr("x", 40)
        .attr("y", j * 25 + 15)
        .text(labels[j]);

    }

    let category_buttons = svg.append("g").attr("transform", "translate(850, 300)");
    for (let k = 0; k < 6; k++){
      category_buttons.append("text")
        .attr("class", "category_buttons")
        .attr("id", categories[k])
        .attr("x", 0)
        .attr("y", k*20)
        .style("opacity", (k === 0) ? 1 : 0.4)
        .text(categories[k]);
    }

    //buttons
    let female_button = d3.select("text#Female");
    let male_button = d3.select("text#Male");
    let white_button = d3.select("text#White");
    let asian_button = d3.select("text#Asian");
    let latino_button = d3.select("text#Latino");
    let black_button = d3.select("text#Black");

    //different layers
    let female = svg.append("g");
    let male = svg.append("g").attr("display", "none");
    let white = svg.append("g").attr("display", "none");
    let asian = svg.append("g").attr("display", "none");
    let latino = svg.append("g").attr("display", "none");
    let black = svg.append("g").attr("display", "none");

    let category_layers = [female, male, white, asian, latino, black];

    //drawing lines
    for (let i = 0; i < 5; i++){
      female.append("path")
            .datum(processedData[i].female)
            .attr("class", "line")
            .attr("d", line)
            .style("stroke", colors[i])
            .style("fill", "none")
            .style("stroke-width", "3")
            .attr("transform", "translate(25, 10)");

      male.append("path")
            .datum(processedData[i].male)
            .attr("class", "line")
            .attr("d", line)
            .style("stroke", colors[i])
            .style("fill", "none")
            .style("stroke-width", "3")
            .attr("transform", "translate(25, 10)");

      black.append("path")
          .datum(processedData[i].black)
          .attr("class", "line")
          .attr("d", line)
          .style("stroke", colors[i])
          .style("fill", "none")
          .style("stroke-width", "3")
          .attr("transform", "translate(25, 10)");

      white.append("path")
           .datum(processedData[i].white)
           .attr("class", "line")
           .attr("d", line)
           .style("stroke", colors[i])
           .style("fill", "none")
           .style("stroke-width", "3")
           .attr("transform", "translate(25, 10)");

      latino.append("path")
           .datum(processedData[i].latino)
           .attr("class", "line")
           .attr("d", line)
           .style("stroke", colors[i])
           .style("fill", "none")
           .style("stroke-width", "3")
           .attr("transform", "translate(25, 10)");

      asian.append("path")
           .datum(processedData[i].asian)
           .attr("class", "line")
           .attr("d", line)
           .style("stroke", colors[i])
           .style("fill", "none")
           .style("stroke-width", "3")
           .attr("transform", "translate(25, 10)");

    }

    let buttons_list = [female_button, male_button, white_button, asian_button,
        latino_button, black_button];

    //handles clicking
    function click(num){
      for (let i = 0; i < 6; i++){
        if (i === num){
          category_layers[i].attr("display", "block");
          buttons_list[i].style("opacity", 1);
        } else {
          category_layers[i].attr("display", "none");
          buttons_list[i].style("opacity", 0.4);
        }
      }
    }

    //mouse events
    female_button.on("click", function(){
      click(0);
    });

    male_button.on("click", function(){
      click(1);
    });

    white_button.on("click", function(){
      click(2);
    });

    asian_button.on("click", function(){
      click(3);
    })

    latino_button.on("click", function(){
      click(4);
    })

    black_button.on("click", function(){
      click(5);
    })


  }

  requestData();
  </script>


</body>
</html>
